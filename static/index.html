<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agentic Noir - Film Noir Detective Game</title>
    <link rel="icon" type="image/png" href="/static/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #0d0d0d;
        --bg-medium: #1a1a1a;
        --bg-light: #2b2b2b;
        --text-primary: #e0e0e0;
        --text-dim: #888;
        --accent-gold: #d4a843;
        --accent-red: #8b0000;
        --npc-blue: #7cb7ff;
        --player-green: #8bc34a;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Courier Prime", "Consolas", monospace;
        background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1515 100%);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* === LOBBY SCREEN === */
      #lobby-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .logo {
        font-family: "Special Elite", cursive;
        font-size: 3.5rem;
        color: var(--accent-gold);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        margin-bottom: 10px;
        letter-spacing: 3px;
      }

      .tagline {
        color: var(--text-dim);
        font-size: 1.1rem;
        margin-bottom: 40px;
        font-style: italic;
      }

      .lobby-card {
        background: var(--bg-medium);
        border: 1px solid #333;
        border-radius: 8px;
        padding: 30px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        position: relative; /* For settings button positioning */
      }

      .lobby-section {
        margin-bottom: 25px;
      }

      /* ... skipped ... */

      .settings-toggle-btn:hover {
        color: var(--accent-gold);
      }

      /* Settings Icon Button (Absolute inside Card) */
      .settings-icon-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: none;
        color: var(--text-dim);
        padding: 0;
        width: 32px;
        height: 32px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .settings-icon-btn svg {
        width: 100%;
        height: 100%;
        fill: currentColor;
        filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
      }

      .settings-icon-btn:hover {
        color: var(--accent-gold);
        transform: rotate(180deg) scale(1.1);
        filter: drop-shadow(0 0 8px rgba(212, 168, 67, 0.6));
      }

      .lobby-section {
        margin-bottom: 25px;
      }

      .lobby-section h3 {
        color: var(--accent-gold);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 15px;
        border-bottom: 1px solid #333;
        padding-bottom: 8px;
      }

      .nickname-input {
        display: flex;
        gap: 10px;
      }

      .nickname-input input {
        flex: 1;
        padding: 12px 15px;
        background: var(--bg-light);
        border: 1px solid #444;
        border-radius: 4px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
      }

      .nickname-input input:focus {
        outline: none;
        border-color: var(--accent-gold);
      }

      .nickname-input button {
        padding: 12px 20px;
        background: var(--accent-gold);
        color: var(--bg-dark);
        border: none;
        border-radius: 4px;
        font-family: inherit;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }

      .nickname-input button:hover {
        background: #e5b954;
      }

      .player-list {
        list-style: none;
        max-height: 200px;
        overflow-y: auto;
      }

      .player-list li {
        padding: 10px 15px;
        background: var(--bg-light);
        border-radius: 4px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .player-list li.you {
        border-left: 3px solid var(--accent-gold);
      }

      .player-badge {
        width: 10px;
        height: 10px;
        background: var(--player-green);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .case-select {
        width: 100%;
        padding: 12px 15px;
        background: var(--bg-light);
        border: 1px solid #444;
        border-radius: 4px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
      }

      .case-description {
        margin-top: 15px;
        padding: 15px;
        background: rgba(212, 168, 67, 0.1);
        border-left: 3px solid var(--accent-gold);
        border-radius: 0 4px 4px 0;
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .start-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(
          135deg,
          var(--accent-gold) 0%,
          #b8942f 100%
        );
        color: var(--bg-dark);
        border: none;
        border-radius: 4px;
        font-family: "Special Elite", cursive;
        font-size: 1.3rem;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .start-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(212, 168, 67, 0.3);
      }

      .start-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .waiting-text {
        text-align: center;
        color: var(--text-dim);
        margin-top: 15px;
        font-size: 0.9rem;
      }

      /* === GAME SCREEN === */
      #game-screen {
        display: none;
        flex-direction: column;
        height: 100vh;
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
        width: 100%;
      }

      .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
      }

      .game-title {
        font-family: "Special Elite", cursive;
        font-size: 1.5rem;
        color: var(--accent-gold);
      }

      .game-info {
        display: flex;
        gap: 20px;
        font-size: 0.85rem;
        color: var(--text-dim);
      }

      .players-online {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .players-online .dot {
        width: 8px;
        height: 8px;
        background: var(--player-green);
        border-radius: 50%;
      }

      #game-log {
        flex: 1;
        background: var(--bg-medium);
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
        line-height: 1.7;
      }

      .log-entry {
        margin-bottom: 15px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .log-narrator {
        color: var(--text-dim);
        font-style: italic;
        padding-left: 20px;
        border-left: 2px solid #444;
      }

      .log-npc {
        color: var(--npc-blue);
      }

      .log-npc .speaker {
        font-weight: bold;
      }

      .log-player {
        color: var(--player-green);
      }

      .log-system {
        color: var(--accent-gold);
        font-size: 0.9rem;
      }

      .input-area {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      #action-input {
        flex: 1;
        padding: 15px;
        background: var(--bg-light);
        border: 1px solid #444;
        border-radius: 4px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
      }

      #action-input:focus {
        outline: none;
        border-color: var(--accent-gold);
      }

      .send-btn {
        padding: 15px 25px;
        background: var(--accent-gold);
        color: var(--bg-dark);
        border: none;
        border-radius: 4px;
        font-family: inherit;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }

      .send-btn:hover {
        background: #e5b954;
      }

      .game-commands {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        font-size: 0.85rem;
      }

      .cmd-btn {
        padding: 8px 15px;
        background: transparent;
        border: 1px solid #444;
        color: var(--text-dim);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .cmd-btn:hover {
        border-color: var(--accent-gold);
        color: var(--accent-gold);
      }

      /* Switch Styling */
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 8px;
        background: transparent;
        border: 1px solid #444;
        padding: 5px 12px;
        border-radius: 4px;
        color: var(--text-dim);
      }

      .toggle-container:hover {
        border-color: var(--accent-gold);
        color: var(--accent-gold);
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 18px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #444;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 12px;
        width: 12px;
        left: 3px;
        bottom: 3px;
        background-color: #888;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--accent-gold);
      }

      input:checked + .slider:before {
        transform: translateX(16px);
        background-color: var(--bg-dark);
      }

      .toggle-label {
        font-size: 0.85rem;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-dark);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Audio Button */
      .play-audio-btn {
        background: transparent;
        border: 1px solid var(--accent-gold);
        color: var(--accent-gold);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        vertical-align: middle;
      }

      .play-audio-btn:hover {
        background: var(--accent-gold);
        color: var(--bg-dark);
        transform: scale(1.1);
      }

      .play-audio-btn.playing {
        animation: pulse-gold 1s infinite;
      }

      @keyframes pulse-gold {
        0% {
          box-shadow: 0 0 0 0 rgba(212, 168, 67, 0.7);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(212, 168, 67, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(212, 168, 67, 0);
        }
      }
      /* Settings Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: var(--bg-medium);
        border: 1px solid var(--accent-gold);
        border-radius: 8px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        animation: fadeIn 0.3s ease;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
      }

      .modal-header h2 {
        color: var(--accent-gold);
        font-family: "Special Elite", cursive;
        margin: 0;
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 1.5rem;
        cursor: pointer;
      }

      .close-btn:hover {
        color: var(--text-primary);
      }

      .setting-row {
        margin-bottom: 20px;
      }

      .setting-row label {
        display: block;
        color: var(--text-dim);
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .setting-row select,
      .setting-row input {
        width: 100%;
        padding: 10px;
        background: var(--bg-dark);
        border: 1px solid #444;
        color: var(--text-primary);
        border-radius: 4px;
        font-family: inherit;
      }

      .save-settings-btn {
        width: 100%;
        padding: 12px;
        background: var(--npc-blue);
        color: var(--bg-dark);
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .save-settings-btn:hover {
        opacity: 0.9;
      }

      .settings-toggle-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        text-decoration: underline;
        cursor: pointer;
        margin-top: 15px;
        font-size: 0.8rem;
      }

      .settings-toggle-btn:hover {
        color: var(--accent-gold);
      }

      /* Hide old text button */
      .settings-toggle-btn {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- LOBBY SCREEN -->
    <div id="lobby-screen">
      <h1 class="logo">AGENTIC NOIR</h1>
      <p class="tagline">A Collaborative Detective Experience</p>

      <div class="lobby-card">
        <button
          class="settings-icon-btn"
          onclick="openSettings()"
          title="Game Settings"
          aria-label="Settings"
        >
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"
            />
          </svg>
        </button>

        <div class="lobby-section" id="nickname-section">
          <h3>Your Identity</h3>
          <div class="nickname-input">
            <input
              type="text"
              id="nickname-input"
              placeholder="Enter your detective name..."
              maxlength="20"
            />
            <button id="set-nickname-btn">Join</button>
          </div>
        </div>

        <div class="lobby-section">
          <h3>Detectives in Lobby</h3>
          <ul class="player-list" id="player-list">
            <li class="waiting"><em>Waiting for players...</em></li>
          </ul>
        </div>

        <div class="lobby-section">
          <h3>Select Case</h3>
          <select class="case-select" id="case-select">
            <option value="iris_bell">The Iris Bell Murder</option>
          </select>
          <div class="case-description" id="case-description">
            <strong>Greywater City, 1947.</strong> A torch singer lies dead in
            her dressing room at The Silver Gull nightclub. Three suspects. One
            truth. The rain won't stop, and neither will you.
          </div>
        </div>

        <button class="start-btn" id="start-btn" disabled>
          Begin Investigation
        </button>
        <p class="waiting-text" id="waiting-text">
          Waiting for at least 1 player to join...
        </p>
      </div>

      <!-- SETTINGS MODAL -->
      <div id="settings-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Game Configuration</h2>
            <button class="close-btn" onclick="closeSettings()">&times;</button>
          </div>

          <div class="setting-row">
            <label for="director-model">Director AI Model (Game Logic)</label>
            <select id="director-model">
              <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
              <option value="gpt-4o">GPT-4o (Smart)</option>
            </select>
            <small>Controls the game logic and world simulation.</small>
          </div>

          <div class="setting-row">
            <label for="narrator-tts-model">Narrator Voice Model (TTS)</label>
            <select id="narrator-tts-model">
              <option value="gemini-2.5-flash-preview-tts">
                Gemini 2.5 Flash TTS (Default)
              </option>
              <option value="gemini-2.5-pro-preview-tts">
                Gemini 2.5 Pro TTS (High Quality)
              </option>
            </select>
            <small>Controls the voice generation for NPCs.</small>
          </div>

          <div class="setting-row">
            <label for="setting-intro-audio">Intro Audio</label>
            <div class="toggle-container" style="justify-content: space-between; background: var(--bg-dark); padding: 10px; border: 1px solid #444;">
                <span style="font-size: 0.9rem; color: var(--text-primary);">Play Cinematic Intro</span>
                <label class="switch">
                    <input type="checkbox" id="setting-intro-audio" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <small>If enabled, plays the noir intro narration when the game starts.</small>
          </div>



          <button class="save-settings-btn" onclick="saveSettings()">
            Save Configuration
          </button>
        </div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen">
      <div class="game-header">
        <h1 class="game-title">The Iris Bell Murder</h1>
        <div class="game-info">
          <div class="players-online">
            <span class="dot"></span>
            <span id="online-count">1 detective</span>
          </div>
          <span id="location-display">The Silver Gull</span>
        </div>
      </div>

      <div id="game-log"></div>

      <div class="input-area">
        <input
          type="text"
          id="action-input"
          placeholder="Describe your action..."
        />
        <button class="send-btn" id="send-btn">Send</button>
      </div>

      <div class="game-commands">
        <button class="cmd-btn" onclick="sendCommand('/inventory')">
          Inventory
        </button>
        <button class="cmd-btn" onclick="sendCommand('/reset')">
          Reset Game
        </button>

        <div class="toggle-container" title="Autoplay Character Voices">
          <span class="toggle-label">Autoplay</span>
          <label class="switch">
            <input
              type="checkbox"
              id="autoplay-switch"
              onchange="toggleAutoplaySwitch()"
            />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <script>
      // === STATE ===
      let ws = null;
      let myID = null;
      let myNickname = null;
      let gameStarted = false;
      let players = {};

      // === DOM ELEMENTS ===
      const lobbyScreen = document.getElementById("lobby-screen");
      const gameScreen = document.getElementById("game-screen");
      const nicknameInput = document.getElementById("nickname-input");
      const setNicknameBtn = document.getElementById("set-nickname-btn");
      const nicknameSection = document.getElementById("nickname-section");
      const playerList = document.getElementById("player-list");
      const startBtn = document.getElementById("start-btn");
      const waitingText = document.getElementById("waiting-text");
      const gameLog = document.getElementById("game-log");
      const actionInput = document.getElementById("action-input");
      const sendBtn = document.getElementById("send-btn");
      const onlineCount = document.getElementById("online-count");

      // === WEBSOCKET CONNECTION ===
      function connect() {
        ws = new WebSocket("ws://" + window.location.host + "/ws");

        ws.onopen = () => {
          console.log("Connected to server");
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleMessage(data);
        };

        ws.onclose = () => {
          console.log("Disconnected from server");
          setTimeout(connect, 2000);
        };
      }

      // === MESSAGE HANDLER ===
      function handleMessage(data) {
        switch (data.type) {
          case "assign_id":
            myID = data.player_id;
            break;

          case "player_list":
            updatePlayerList(data.players);
            break;

          case "game_started":
            startGame(data);
            break;

          case "system":
            addLogEntry("system", data.text);
            break;

          case "chat":
            addLogEntry("player", `[${data.sender}] ${data.text}`);
            break;

          case "scene":
            data.data.forEach((line) => {
              let audioHtml = "";
              let safeUrl = "";
              if (line.audio_url) {
                // Use a proper onclick handler that calls our global function
                // Escaping the URL just in case
                safeUrl = line.audio_url.replace(/"/g, "&quot;");
                audioHtml = `<button class="play-audio-btn" onclick="playAudio('${safeUrl}', this)">▶</button>`;
              }

              let entry;
              if (line.speaker === "NARRATOR") {
                entry = addLogEntry("narrator", line.text);
              } else {
                entry = addLogEntry(
                  "npc",
                  `${audioHtml}<span class="speaker">${line.speaker}:</span> "${line.text}"`,
                );
              }

              // Auto-queue
              if (autoplayEnabled && line.audio_url && entry) {
                const btn = entry.querySelector(".play-audio-btn");
                if (btn) {
                  audioQueue.push({ url: line.audio_url, btn: btn });
                }
              }
            });

            if (autoplayEnabled && !isPlayingQueue && audioQueue.length > 0) {
              processAudioQueue();
            }
            break;

          case "processing":
            setProcessingState(data.status);
            break;
        }
      }

      // === AUDIO HANDLER ===
      let currentAudio = null;
      let currentBtn = null;
      let audioQueue = [];
      let isPlayingQueue = false;

      // Load preference
      let autoplayEnabled = localStorage.getItem("autoplay_audio") === "true";

      function playAudio(url, btn, isAuto = false) {
        // Stop current if playing
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          if (currentBtn) {
            currentBtn.classList.remove("playing");
            currentBtn.innerHTML = "▶";
          }
        }

        // If clicking same button manually, just stop
        if (
          !isAuto &&
          currentBtn === btn &&
          currentAudio &&
          !currentAudio.paused
        ) {
          currentAudio = null;
          currentBtn = null;
          isPlayingQueue = false;
          audioQueue = []; // Clear queue on manual stop
          return;
        }

        const audio = new Audio(url);
        currentAudio = audio;
        currentBtn = btn;

        if (btn) {
          btn.classList.add("playing");
          btn.innerHTML = "■";
        }

        audio.onended = () => {
          if (btn) {
            btn.classList.remove("playing");
            btn.innerHTML = "▶";
          }
          currentAudio = null;
          currentBtn = null;

          if (isAuto) {
            processAudioQueue();
          }
        };

        audio.play().catch((e) => {
          console.error("Audio playback error:", e);
          if (btn) {
            btn.classList.remove("playing");
            btn.innerHTML = "⚠️";
          }
          // If failed, try next
          if (isAuto) processAudioQueue();
        });
      }

      function processAudioQueue() {
        if (audioQueue.length === 0) {
          isPlayingQueue = false;
          return;
        }

        isPlayingQueue = true;
        const nextItem = audioQueue.shift();
        playAudio(nextItem.url, nextItem.btn, true);
      }

      // === LOBBY FUNCTIONS ===
      function updatePlayerList(playerData) {
        players = playerData;
        const count = Object.keys(players).length;

        if (count === 0) {
          playerList.innerHTML =
            '<li class="waiting"><em>Waiting for players...</em></li>';
        } else {
          playerList.innerHTML = Object.entries(players)
            .map(([id, info]) => {
              const isYou = id === myID;
              const name = info.nickname || `Detective-${id.slice(-3)}`;
              return `<li class="${isYou ? "you" : ""}">
                        <span class="player-badge"></span>
                        ${escapeHtml(name)} ${isYou ? "(you)" : ""}
                    </li>`;
            })
            .join("");
        }

        // Update start button state
        const readyCount = Object.values(players).filter(
          (p) => p.nickname,
        ).length;
        if (readyCount >= 1 && myNickname) {
          startBtn.disabled = false;
          waitingText.textContent = `${readyCount} detective${readyCount > 1 ? "s" : ""} ready. Anyone can start the game.`;
        } else {
          startBtn.disabled = true;
          waitingText.textContent = "Enter your name to join...";
        }

        // Update online count in game
        onlineCount.textContent = `${count} detective${count !== 1 ? "s" : ""}`;
      }

      function setNickname() {
        const name = nicknameInput.value.trim();
        if (name && ws) {
          myNickname = name;
          ws.send(JSON.stringify({ type: "nickname", nickname: name }));

          // Update UI
          nicknameInput.disabled = true;
          setNicknameBtn.disabled = true;
          setNicknameBtn.textContent = "Joined!";
        }
      }

      function requestStartGame() {
        if (ws) {
          ws.send(
            JSON.stringify({
              type: "start_game",
              case: document.getElementById("case-select").value,
            }),
          );
        }
      }

      function startGame(data) {
        gameStarted = true;
        lobbyScreen.style.display = "none";
        gameScreen.style.display = "flex";

        // Add intro message
        if (data.intro) {
          addLogEntry("system", data.intro);
        }

        // PLAY INTRO AUDIO IF ENABLED
        const playIntro = document.getElementById("setting-intro-audio").checked;
        if (playIntro && data.intro_audio_url) {
            const audio = new Audio(data.intro_audio_url);
            audio.play().catch(e => console.error("Intro audio playback failed:", e));
        }
      }

      // === GAME FUNCTIONS ===
      function addLogEntry(type, content) {
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = content;
        gameLog.appendChild(entry);
        gameLog.scrollTop = gameLog.scrollHeight;
        return entry;
      }

      function setProcessingState(isProcessing) {
        actionInput.disabled = isProcessing;
        sendBtn.disabled = isProcessing;

        if (isProcessing) {
          actionInput.placeholder = "Agents are resolving action...";
          sendBtn.textContent = "...";
          sendBtn.style.opacity = "0.7";
          sendBtn.style.cursor = "not-allowed";
        } else {
          actionInput.placeholder = "Describe your action...";
          sendBtn.textContent = "Send";
          sendBtn.style.opacity = "1";
          sendBtn.style.cursor = "pointer";
          setTimeout(() => actionInput.focus(), 100);
        }
      }

      function sendAction() {
        const text = actionInput.value.trim();
        if (text && ws) {
          ws.send(JSON.stringify({ type: "chat", text: text }));
          actionInput.value = "";
        }
      }

      function sendCommand(cmd) {
        if (ws) {
          ws.send(JSON.stringify({ type: "chat", text: cmd }));
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // === EVENT LISTENERS ===
      setNicknameBtn.addEventListener("click", setNickname);
      nicknameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") setNickname();
      });

      startBtn.addEventListener("click", requestStartGame);

      sendBtn.addEventListener("click", sendAction);
      actionInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendAction();
      });

      // === SETTINGS FUNCTIONS ===
      const settingsModal = document.getElementById("settings-modal");
      const directorSelect = document.getElementById("director-model");
      const ttsSelect = document.getElementById("narrator-tts-model");
      const autoplaySwitch = document.getElementById("autoplay-switch");

      // Initialize Switch State
      initAutoplayState();

      function initAutoplayState() {
        autoplaySwitch.checked = autoplayEnabled;
      }

      function toggleAutoplaySwitch() {
        autoplayEnabled = autoplaySwitch.checked;
        localStorage.setItem("autoplay_audio", autoplayEnabled);

        // If turned on and items in queue, start playing
        if (autoplayEnabled && !isPlayingQueue && audioQueue.length > 0) {
          processAudioQueue();
        }
      }

      function openSettings() {
        // Fetch current settings
        fetch("/settings")
          .then((res) => res.json())
          .then((data) => {
            directorSelect.value = data.director_model || "gpt-4o-mini";
            ttsSelect.value =
              data.narrator_tts_model || "gemini-2.5-flash-preview-tts";
            settingsModal.style.display = "flex";
          })
          .catch((err) => {
            console.error("Error loading settings:", err);
            alert("Failed to load settings.");
          });
      }

      function closeSettings() {
        settingsModal.style.display = "none";
      }

      function saveSettings() {
        const settings = {
          director_model: directorSelect.value,
          narrator_tts_model: ttsSelect.value,
        };

        fetch("/settings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(settings),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              alert("Settings saved!");
              closeSettings();
            } else {
              alert("Error saving settings.");
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Error saving settings.");
          });
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == settingsModal) {
          closeSettings();
        }
      };

      // === INIT ===
      connect();
    </script>
  </body>
</html>
